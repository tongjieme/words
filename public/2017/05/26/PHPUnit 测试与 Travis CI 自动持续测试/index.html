<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> PHPUnit 测试与 Travis CI 自动持续测试 · Tong Jiewen</title><meta name="description" content="PHPUnit 测试与 Travis CI 自动持续测试 - Tong Jiewen"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><!-- - var xml = config.url + '/atom.xml'//- link(rel="search", type="application/opensearchdescription+xml", href=xml, title=config.title)--></head><body><div class="wrap"><header><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/tongjieme" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/qr.html" target="_self" class="nav-list-link">QRCODE</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">PHPUnit 测试与 Travis CI 自动持续测试</h1><div class="post-info">May 26, 2017</div><div class="post-content"><p>对程序编写自动化的测试是非常有好处的, 这可以让我们每次迭代更新程序, 以及部署程序到线上生产环境之前提前发现问题, 从此不用发布到线上担惊受怕会出bug</p>
<p>PHP 测试可以使用 PHPUnit 测试框架</p>
<h3 id="安装PHPUnit"><a href="#安装PHPUnit" class="headerlink" title="安装PHPUnit"></a>安装PHPUnit</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">composer require --dev phpunit/phpunit</div></pre></td></tr></table></figure>
<p>安装好了之后, 可以试着运行 <code>vendor/bin/phpunit -v</code> </p>
<h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><p>新建好下面的目录结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">├── composer.json</div><div class="line">├── composer.lock</div><div class="line">├── phpunit.xml         # phpunit 的配置文件</div><div class="line">├── src                 # 需要被测试的代码</div><div class="line">│   └── Animal.php</div><div class="line">├── tests               # 测试用例存放的文件夹</div><div class="line">│   ├── AnimalTest.php  # 测试用例</div><div class="line">│   └── bootstrap.php   # phpunit 入口文件</div><div class="line">└── vendor              # 第三方composer 组件</div><div class="line">    ├── autoload.php</div><div class="line">    ├── bin</div><div class="line">    ├── composer</div><div class="line">    ├── doctrine</div><div class="line">    ├── myclabs</div><div class="line">    ├── phpdocumentor</div><div class="line">    ├── phpspec</div><div class="line">    ├── phpunit</div><div class="line">    ├── sebastian</div><div class="line">    ├── symfony</div><div class="line">    └── webmozart</div></pre></td></tr></table></figure></p>
<h3 id="准备要测试的代码"><a href="#准备要测试的代码" class="headerlink" title="准备要测试的代码"></a>准备要测试的代码</h3><p>假设我们要测试<code>src/Animal.php</code>, 里面的构造方法是否成功初始化Animal 示例的名字<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">namespace App;</div><div class="line"></div><div class="line">class Animal</div><div class="line">&#123;</div><div class="line">    protected $name;</div><div class="line"></div><div class="line">    public function __construct($name)</div><div class="line">    &#123;</div><div class="line">        $this-&gt;setName($name);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * @return mixed</div><div class="line">     */</div><div class="line">    public function getName()</div><div class="line">    &#123;</div><div class="line">        return $this-&gt;name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * @param mixed $name</div><div class="line">     */</div><div class="line">    public function setName($name)</div><div class="line">    &#123;</div><div class="line">        $this-&gt;name = $name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="配置PHPUnit"><a href="#配置PHPUnit" class="headerlink" title="配置PHPUnit"></a>配置PHPUnit</h3><p>修改 <code>phpunit.xml</code> 添加以下内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;phpunit bootstrap=&quot;tests/bootstrap.php&quot;&gt;</div><div class="line">  &lt;testsuites&gt;</div><div class="line">    &lt;testsuite name=&quot;Animal&quot;&gt;</div><div class="line">      &lt;directory suffix=&quot;Test.php&quot;&gt;tests&lt;/directory&gt;</div><div class="line">    &lt;/testsuite&gt;</div><div class="line">  &lt;/testsuites&gt;</div><div class="line">&lt;/phpunit&gt;</div></pre></td></tr></table></figure></p>
<p>我们制定tests文件里面以Test.php 结尾的文件都是测试用例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;testsuite name=&quot;Animal&quot;&gt;</div><div class="line">  &lt;directory suffix=&quot;Test.php&quot;&gt;tests&lt;/directory&gt;</div><div class="line">&lt;/testsuite&gt;</div></pre></td></tr></table></figure></p>
<h3 id="bootstrap-php"><a href="#bootstrap-php" class="headerlink" title="bootstrap.php"></a>bootstrap.php</h3><p>phpunit 会在运行测试的时候首先运行<code>tests/bootstrap.php</code>文件, 所以为了测试用例的编写便利, 可以在文件中添加composer 的自动加载<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">require dirname(__DIR__) . &apos;/vendor/autoload.php&apos;;</div></pre></td></tr></table></figure></p>
<h3 id="测试用例-test-case"><a href="#测试用例-test-case" class="headerlink" title="测试用例(test case)"></a>测试用例(test case)</h3><p>每个测试用例就是一个类, 每个类的方法就是一个测试, 测试用例组成测试组件(test suite)</p>
<p>在 <code>phpunit.xml</code> 配置里 我们配置了 <code>&lt;directory suffix=&quot;Test.php&quot;&gt;tests&lt;/directory&gt;</code>, 所以<code>test</code> 文件夹就是我们存放测试用例的地方, 而且所有的测试用例文件应该以 Test.php结尾来命名<br>phpunit 会运行所有测试用例里面每个以test开头的方法, 每个方法都是一个测试<br><code>tests/AnimalTest.php</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">namespace App;</div><div class="line"></div><div class="line">use PHPUnit\Framework\TestCase;</div><div class="line"></div><div class="line">class AnimalTest extends TestCase</div><div class="line">&#123;</div><div class="line">    public function testSetNameWithConstructor()</div><div class="line">    &#123;</div><div class="line">        $animal = new Animal(&apos;James&apos;);</div><div class="line">        $this-&gt;assertAttributeEquals(&apos;James&apos;, &apos;name&apos;, $animal);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vendor/bin/phpunit -c phpunit.xml</div></pre></td></tr></table></figure>
<p>测试结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">PHPUnit 5.7.19 by Sebastian Bergmann and contributors.</div><div class="line"></div><div class="line">.                                                                   1 / 1 (100%)</div><div class="line"></div><div class="line">Time: 113 ms, Memory: 3.75MB</div><div class="line"></div><div class="line">OK (1 test, 2 assertions)</div></pre></td></tr></table></figure></p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/06/02/MySQL 日志/" class="prev">上一篇</a><a href="/2017/05/10/解决 SSH 登陆linux 慢的问题/" class="next">下一篇</a></div></footer></div></body></html>